<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Virginia's Interactive 3D Digital Garden Planner — Pro v3</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#334155; --text:#e5e7eb; --accent:#22c55e; --accent2:#14b8a6; --warn:#f59e0b; --danger:#ef4444; --info:#60a5fa; --soil:#6b4f2a; --stone:#9ca3af; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);height:100vh;display:flex;}
    .sidebar{width:380px;background:rgba(17,24,39,.88);backdrop-filter: blur(8px);border-right:1px solid #1f2937;display:flex;flex-direction:column}
    .header{padding:12px 16px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{font-weight:700;letter-spacing:.2px}
    .location{font-size:.85rem;color:#a3a3a3}
    .library{padding:12px 12px 120px 12px;overflow:auto}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
    .chip{padding:6px 10px;border:1px solid #334155;border-radius:999px;font-size:.8rem;cursor:pointer;user-select:none}
    .chip.active{background:var(--accent);border-color:transparent;color:#07210f}
    .search{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:var(--text)}
    .btn{background:#1f2937;color:#e5e7eb;border:1px solid #2a3342;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#14b8a6);color:#051b0f;border:none}
    .btn.warn{background:#3b2f06;border-color:#f59e0b;color:#fbbf24}
    .btn.danger{background:#3b0d0d;border-color:#ef4444;color:#fecaca}
    .btn.ghost{background:transparent;border-color:#334155}
    .btn.small{padding:6px 8px;font-size:.85rem}
    .toolbar{position:sticky;bottom:0;display:flex;gap:8px;padding:10px;background:rgba(15,23,42,.9);backdrop-filter: blur(8px);border-top:1px solid #1f2937}
    .plant-card{display:grid;grid-template-columns:auto 1fr;gap:10px;padding:10px;border:1px solid #334155;border-radius:10px;background:#0b1220}
    .plant-card img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #1f2937}
    .plant-card .meta{font-size:.8rem;color:#9ca3af}
    .right{flex:1;display:flex;flex-direction:column;min-width:0}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #1f2937;background:rgba(2,6,23,.6);backdrop-filter: blur(8px)}
    .status{display:flex;gap:10px;align-items:center;font-size:.9rem;color:#a3a3a3;flex-wrap:wrap}
    .pill{border:1px solid #334155;padding:4px 8px;border-radius:999px;white-space:nowrap}
    .inline{display:flex;gap:8px;align-items:center}
    .canvas-wrap{position:relative;flex:1;display:flex}
    #garden2d{background:radial-gradient(1200px 1200px at 30% 20%, #12311a, #08140a);width:100%;height:100%;cursor:default}
    #rainCanvas{position:absolute;inset:0;pointer-events:none}
    #scene3d{position:absolute;inset:0;display:none}

    .drawer{width:360px;border-left:1px solid #1f2937;background:#0b1220;display:none;flex-direction:column}
    .drawer.show{display:flex}
    .drawer header{padding:12px 14px;border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;align-items:center}
    .drawer .body{padding:12px;overflow:auto}

    .panel{padding:12px;border:1px solid #334155;border-radius:10px;background:#0b1220}
    .small{font-size:.8rem;color:#9ca3af}

    @media (max-width: 1120px){ .sidebar{display:none} .drawer{width:320px} }
    .kbd{padding:1px 6px;border:1px solid #475569;border-bottom-width:2px;border-radius:6px;background:#0b1220;font:600 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;color:#e5e7eb}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="header">
      <div>
        <div class="brand">Interactive 3D Digital Garden Planner</div>
        <div class="location">Calgary, AB</div>
      </div>
      <div class="inline">
        <button id="btnApiKey" class="btn small">API Key</button>
        <button id="btnImportXLSX" class="btn ghost small" title="Import custom plant list (.xlsx)">Import .xlsx</button>
        <input id="fileXLSX" type="file" accept=".xlsx,.xls" style="display:none" />
      </div>
    </div>

    <div style="padding:10px;border-bottom:1px solid #1f2937">
      <div class="inline" style="justify-content:space-between">
        <h3 style="margin:6px 0">Plant Library</h3>
        <div class="inline">
          <button id="btnPalette" class="btn ghost small">✨ Palette</button>
          <button id="btnRefreshLib" class="btn ghost small" title="Refresh library">↻</button>
        </div>
      </div>
      <div class="small">USDA Zone (est.): <span id="zoneLabel">3b–4a</span></div>
      <input id="search" class="search" placeholder="Search plants by name…"/>
      <div class="filters">
        <div class="panel">
          <div class="small">Sunlight</div>
          <div class="chips" id="sunChips">
            <div class="chip" data-value="">All</div>
            <div class="chip" data-value="full_sun">Full Sun</div>
            <div class="chip" data-value="part_shade">Part Shade</div>
            <div class="chip" data-value="full_shade">Full Shade</div>
          </div>
        </div>
        <div class="panel">
          <div class="small">Watering</div>
          <div class="chips" id="waterChips">
            <div class="chip" data-value="">All</div>
            <div class="chip" data-value="frequent">Frequent</div>
            <div class="chip" data-value="average">Average</div>
            <div class="chip" data-value="minimum">Minimum</div>
          </div>
        </div>
      </div>
    </div>

    <div class="library" id="library">
      <div class="small">Loading plants…</div>
    </div>

    <div class="toolbar">
      <button id="btnTemplates" class="btn small">Templates</button>
      <button id="btnSave" class="btn small">Save</button>
      <button id="btnLoad" class="btn small">Load</button>
      <button id="btnUndo" class="btn small" title="Undo (Ctrl/Cmd+Z)">Undo</button>
      <button id="btnRedo" class="btn small" title="Redo (Ctrl/Cmd+Y)">Redo</button>
      <button id="btnExport" class="btn small">Export</button>
    </div>
  </aside>

  <main class="right">
    <div class="topbar">
      <div class="status">
        <div class="pill">Weather: <span id="weather">Loading…</span></div>
        <div class="pill">Year: <input id="yearSlider" type="range" min="1" max="8" value="1" style="vertical-align:middle"> <span id="growthLabel">1</span> / <span id="growthMax">8</span></div>
        <div class="pill">Scale: <span id="scaleLabel">1 m ≈ 40 px</span></div>
        <div class="pill" title="Snap nodes/objects to grid"><label><input type="checkbox" id="snapToggle" checked> Snap</label></div>
        <div class="pill" id="selectionInfo" style="display:none"></div>
      </div>
      <div class="inline">
        <button id="btnAddRect" class="btn small" title="Click to start a bed, drag to size">Add Bed</button>
        <button id="btnAddPath" class="btn small" title="Click to add points, double-click to finish">Add Path</button>
        <button id="btnDelete" class="btn danger small" style="display:none">Delete</button>
        <span class="small">Rotate: drag ⟳ handle • Aspect lock: hold <span class="kbd">Shift</span> • Center-resize: hold <span class="kbd">Alt</span></span>
        <button id="btn2D" class="btn small">2D</button>
        <button id="btn3D" class="btn primary small">3D</button>
        <div class="inline">
          <button id="camTop" class="btn ghost small" title="Top-down">Top</button>
          <button id="camOblique" class="btn ghost small" title="Oblique">Oblique</button>
          <button id="camReset" class="btn ghost small" title="Reset view">Reset</button>
        </div>
        <button id="btnRain" class="btn warn small">Rain</button>
        <button id="btnClear" class="btn danger small">Clear</button>
      </div>
    </div>

    <div class="canvas-wrap">
      <canvas id="garden2d"></canvas>
      <canvas id="rainCanvas"></canvas>
      <div id="scene3d"></div>
    </div>

    <div style="padding:10px;border-top:1px solid #1f2937;background:#0b1220" class="small">
      Tips: 
      <span class="kbd">Shift</span> to lock aspect while resizing • 
      <span class="kbd">Alt</span> to resize from center • 
      Double-click a <strong>path</strong> segment to insert a node • 
      <span class="kbd">Alt</span>+Click a node to delete • 
      <span class="kbd">Ctrl/Cmd+Z</span> Undo, <span class="kbd">Ctrl/Cmd+Y</span> Redo.
    </div>
  </main>

  <aside class="drawer" id="drawer">
    <header>
      <strong id="drawerTitle">Plant Details</strong>
      <div class="inline">
        <button id="btnReplaceSimilar" class="btn ghost small">Replace with Similar</button>
        <button id="btnCloseDrawer" class="btn small">✕</button>
      </div>
    </header>
    <div class="body" id="drawerBody"><div class="small">Select a plant dot to view details.</div></div>
  </aside>

  <!-- Modals -->
  <div class="modal" id="modalKey">
    <div class="card">
      <header><strong>Enter API Key</strong></header>
      <div class="body">
        <p>Please enter your <a href="#" target="_blank">Perenual.com</</p>
        <input id="apiKeyInput" class="search" placeholder="perenual_api_key_…" />
      </div>
      <footer>
        <button class="btn ghost" data-close>Cancel</button>
        <button id="saveKey" class="btn primary">Save & Start</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="modalExport">
    <div class="card">
      <header><strong>Export Garden Plan</strong></header>
      <div class="body">
        <div class="panel" style="margin-bottom:10px">
          <h3>Plant Shopping List (.txt)</h3>
          <div class="small">Names and quantities of all plants in your garden.</div>
          <button id="exportList" class="btn" style="margin-top:8px">Download .txt</button>
        </div>
        <div class="panel" style="margin-bottom:10px">
          <h3>Garden Image (.png)</h3>
          <div class="small">A high-resolution image of your 2D garden layout (plants + hardscaping).</div>
          <button id="exportPNG" class="btn" style="margin-top:8px">Download .png</button>
        </div>
        <div class="panel">
          <h3>Share to Community (AI Post)</h3>
          <div class="small">We'll generate a creative description of your garden for sharing online.</div>
          <button id="shareAI" class="btn" style="margin-top:8px">Generate Text</button>
          <textarea id="shareText" class="search" rows="4" placeholder="Your AI description will appear here…" style="margin-top:8px"></textarea>
          <button id="copyShare" class="btn ghost" style="margin-top:8px">Copy Text</button>
        </div>
      </div>
      <footer>
        <button class="btn ghost" data-close>Close</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="modalTemplates">
    <div class="card">
      <header><strong>Garden Templates</strong></header>
      <div class="body">
        <div class="panel">
          <h3>English Cottage</h3>
          <div class="small">A charming, informal design with a mix of ornamental and edible plants.</div>
          <button class="btn" data-template="cottage" style="margin-top:6px">Use Template</button>
        </div>
        <div class="panel" style="margin-top:10px">
          <h3>Modern Minimalist</h3>
          <div class="small">Clean lines, geometric shapes, and a focus on structure and foliage.</div>
          <button class="btn" data-template="modern" style="margin-top:6px">Use Template</button>
        </div>
        <div class="panel" style="margin-top:10px">
          <h3>Zen Garden</h3>
          <div class="small">A tranquil space featuring rocks, pathways, and carefully placed foliage.</div>
          <button class="btn" data-template="zen" style="margin-top:6px">Use Template</button>
        </div>
      </div>
      <footer>
        <button class="btn ghost" data-close>Close</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="modalPalette">
    <div class="card">
      <header><strong>Create a Smart Palette</strong></header>
      <div class="body">
        <p>Describe your goals (e.g., "low-water sunny bed, low maintenance", "shady pollinator pocket"). We'll filter by water/sun/maintenance and Zone.</p>
        <textarea id="palettePrompt" class="search" rows="3" placeholder="Describe your goals…"></textarea>
      </div>
      <footer>
        <button class="btn ghost" data-close>Cancel</button>
        <button id="generatePalette" class="btn primary">Generate</button>
      </footer>
    </div>
  </div>

  <script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.161.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script>
  // ---------------- State ----------------
  const state = {
    apiKey: localStorage.getItem('perenual_api_key') || '',
    plants: [], details: {},
    placed: [], // plants
    hardscape: [], // rects & paths with rotation
    filters: { q:'', sunlight:'', watering:'' },
    isRaining: false, view: '2d',
    growthYearTarget: 1, growthYearDisplay: 1, growthMax: 8,
    pxPerMeter: 40, snap: true,
    selected: { kind:null, index:-1, node:-1, handle:null }, // handle for rect: corner/edge/rotate
    dragging: null, // {kind:'plant'|'rect'|'rect-resize'|'rect-rotate'|'path-node'|'path-move', index, ...}
    drawing: { rect:null, path:null },
    history: [], redo: [],
    cameraPreset: 'oblique'
  };
  const ZONE_TARGET = 4; // Calgary ~3b–4a

  // ---------------- Helpers ----------------
  const $ = (s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>[...e.querySelectorAll(s)];
  const showModal=id=>$(id).classList.add('show'); const closeModal=id=>$(id).classList.remove('show');
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const roundSnap=(v,step=20)=> state.snap ? Math.round(v/step)*step : v;
  function metersToPx(m){ return m*state.pxPerMeter; } function cmToPx(cm){ return metersToPx(cm/100); }
  function inchesToCm(i){return i*2.54;} function feetToCm(f){return f*30.48;}
  function parseDimension(text){ if(!text) return null; text=String(text).toLowerCase(); let m;
    m = text.match(/(\d+(?:\.\d+)?)\s*(?:-|to)\s*(\d+(?:\.\d+)?)\s*(cm|centimeter|mm|millimeter|in|inch|inches|ft|foot|feet)/);
    if(m){return {min:dimToCm(+m[1],m[3]),max:dimToCm(+m[2],m[3])};}
    m = text.match(/(\d+(?:\.\d+)?)\s*(cm|centimeter|mm|millimeter|in|inch|inches|ft|foot|feet)/);
    if(m){const v=dimToCm(+m[1],m[2]); return {min:v,max:v};}
    m = text.match(/(\d+(?:\.\d+)?)/); if(m){const v=+m[1]; return {min:v,max:v};}
    return null; }
  function dimToCm(v,u){u=u.toLowerCase(); if(u.startsWith('mm'))return v/10; if(u.startsWith('cm'))return v; if(u.startsWith('in'))return inchesToCm(v); if(u==='ft'||u.startsWith('foot')||u.startsWith('feet'))return feetToCm(v); return v;}

  // History (Undo/Redo)
  function snapshot(){
    return JSON.stringify({placed:state.placed, hardscape:state.hardscape, growthYearTarget:state.growthYearTarget});
  }
  function pushHistory(label='change'){
    state.history.push(snapshot()); state.redo.length=0;
  }
  function undo(){ if(state.history.length){ const current = snapshot(); state.redo.push(current); const prev = state.history.pop(); const data = JSON.parse(prev); state.placed = data.placed||[]; state.hardscape = data.hardscape||[]; state.growthYearTarget = data.growthYearTarget||1; state.growthYearDisplay = state.growthYearTarget; render2D(); render3D(); }}
  function redo(){ if(state.redo.length){ const current = snapshot(); state.history.push(current); const next = state.redo.pop(); const data = JSON.parse(next); state.placed = data.placed||[]; state.hardscape = data.hardscape||[]; state.growthYearTarget = data.growthYearTarget||1; state.growthYearDisplay = state.growthYearTarget; render2D(); render3D(); }}

  // Library & Details
  function drawLibrary(){ const lib=$('#library'); const q=state.filters.q.toLowerCase(); lib.innerHTML='';
    let filtered=state.plants.filter(p=>{ const mq=!q||(p.common_name||'').toLowerCase().includes(q); const ms=!state.filters.sunlight||(p.sunlight||[]).includes(state.filters.sunlight); const mw=!state.filters.watering||(String(p.watering).toLowerCase()===String(state.filters.watering).toLowerCase()); return mq&&ms&&mw;});
    if(!filtered.length){ lib.innerHTML='<div class="small">No matches. Try different filters.</div>'; return; }
    filtered.slice(0,160).forEach(p=>{ const card=document.createElement('div'); card.className='plant-card'; const img=(p.default_image&&(p.default_image.thumbnail||p.default_image.small_url))||p.image_url||''; card.innerHTML=`
      <img src="${img}" alt="${p.common_name||''}"/>
      <div>
        <div><strong>${p.common_name||'Unknown'}</strong></div>
        <div class="meta">${(p.scientific_name||[]).join(', ')}</div>
        <div class="meta">Water: ${p.watering||'—'} • Sun: ${(p.sunlight||[]).join(' / ')||'—'}</div>
        <div style="margin-top:6px">
          <button class="btn small" data-add>Place</button>
          <button class="btn ghost small" data-info>Details</button>
        </div>
      </div>`; card.querySelector('[data-add]').onclick=()=> addPlantToCanvas(p); card.querySelector('[data-info]').onclick=async()=>{ await ensureDetails(p.id); openDetailsForLibrary(p.id);}; lib.appendChild(card); }); }

  async function fetchLibrary(){ if(!state.apiKey){ $('#library').innerHTML='<div class="small">Add API key (optional) or import .xlsx.</div>'; return; }
    $('#library').innerHTML='<div class="small">Loading plants…</div>';
    try{ const url=`https://perenual.com/api/species-list?key=${state.apiKey}&page=1&size=140&images=1`; const res=await fetch(url); const out=await res.json(); state.plants=(out.data||[]).map(p=>({id:p.id,common_name:p.common_name,scientific_name:p.scientific_name,watering:p.watering,sunlight:p.sunlight,default_image:p.default_image})); drawLibrary(); }
    catch(e){ $('#library').innerHTML='<div class="small">Failed to load plants. You can still use Import .xlsx.</div>'; }
  }

  async function ensureDetails(id){ if(state.details[id]) return state.details[id];
    // For custom IDs (strings), details may already be set
    const base = state.plants.find(p=>p.id===id) || {};
    if(typeof id!=='number'){
      state.details[id] = state.details[id] || { id, common_name: base.common_name||'', scientific_name: base.scientific_name||[], watering: base.watering||'', sunlight: base.sunlight||[], maintenance: base.maintenance||'', heightCm: base.heightCm||null, spreadCm: base.spreadCm||null, hardiness: base.hardiness||'', default_image: base.default_image||{small_url:base.image_url}, description: base.notes||'', notes: base.notes||'' };
      return state.details[id];
    }
    try{ const url=`https://perenual.com/api/species/details/${id}?key=${state.apiKey}`; const res=await fetch(url); const d=await res.json(); const dimText=(d.dimensions||d.dimension||''); const hm=dimText.match(/height\s*:?\s*([^;\n]+)/i); const sm=dimText.match(/(spread|width)\s*:?\s*([^;\n]+)/i); const hR=parseDimension(hm?hm[1]:d.height||''); const sR=parseDimension(sm?sm[2]:d.spread||''); const hard=(d.hardiness||d.hardiness_zone||'')+''; state.details[id]={ id, common_name:d.common_name||'', scientific_name:d.scientific_name||[], watering:d.watering||'', sunlight:d.sunlight||[], maintenance:d.maintenance||'', heightCm:hR?(hR.max||hR.min):null, spreadCm:sR?(sR.max||sR.min):null, hardiness:hard, default_image:d.default_image||null, other_images:d.other_images||[], description:d.description||'', notes:d.care_level||d.care||'' }; }
    catch(e){ console.warn('details fail',id,e);} return state.details[id]; }

  // Placement & Growth
  const canvas=$('#garden2d'); const ctx=canvas.getContext('2d'); const rainCanvas=$('#rainCanvas'); const rainCtx=rainCanvas.getContext('2d');

  function addPlantToCanvas(p,x=null,y=null){ const rect=canvas.getBoundingClientRect(); const base=16; const px=x??rect.width/2+(Math.random()*80-40); const py=y??rect.height/2+(Math.random()*80-40); state.placed.push({ id:p.id, name:p.common_name||'Unknown', water:p.watering||'Average', sun:(p.sunlight||[])[0]||'', x:px,y:py, baseRadius:base, spreadCm:null, heightCm:null }); pushHistory('add plant'); render2D(); render3D(); }

  function radiusAtYear(item, year){ const years=state.growthMax; if(item.spreadCm){ const matureR=cmToPx(item.spreadCm)/2*0.9; const t=(year-1)/(years-1||1); return item.baseRadius + (matureR-item.baseRadius)*t; } return item.baseRadius; }
  function currentRadius(item){ return radiusAtYear(item, state.growthYearDisplay); }

  async function updateGrowthData(){ const promises=[]; for(const it of state.placed){ if(it.spreadCm==null||it.heightCm==null){ promises.push(ensureDetails(it.id).then(d=>{ if(!d) return; if(d.spreadCm) it.spreadCm=d.spreadCm; if(d.heightCm) it.heightCm=d.heightCm; })); } } if(promises.length) await Promise.all(promises); }

  // Tween growthYearDisplay -> growthYearTarget (shaded color factor)
  let growthAnimId=null; function animateGrowth(){ if(growthAnimId) cancelAnimationFrame(growthAnimId); const start=performance.now(); const from=state.growthYearDisplay; const to=state.growthYearTarget; const dur=500; const ease=t=> t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2; const step=(now)=>{ const t=clamp((now-start)/dur,0,1); const e=ease(t); state.growthYearDisplay = from + (to-from)*e; render2D(); render3D(); if(t<1) growthAnimId=requestAnimationFrame(step); }; growthAnimId=requestAnimationFrame(step); }

  // Canvas & Hardscape (rotatable rects)
  function resize(){ const dpr=window.devicePixelRatio||1; const rect=canvas.parentElement.getBoundingClientRect(); canvas.width=rect.width*dpr; canvas.height=rect.height*dpr; canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); rainCanvas.width=canvas.width; rainCanvas.height=canvas.height; rainCanvas.style.width=canvas.style.width; rainCanvas.style.height=canvas.style.height; render2D(); render3D(); }
  window.addEventListener('resize', resize);

  function drawGrid(){ const rect=canvas.getBoundingClientRect(); const step=20; ctx.strokeStyle='#12411f'; ctx.lineWidth=1; for(let x=0;x<rect.width;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,rect.height); ctx.stroke(); } for(let y=0;y<rect.height;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(rect.width,y); ctx.stroke(); } }

  function worldToLocalRect(x,y,r){ const cx=r.x+r.w/2, cy=r.y+r.h/2; const dx=x-cx, dy=y-cy; const s=Math.sin(-(r.rot||0)), c=Math.cos(-(r.rot||0)); return { x: dx*c - dy*s + r.w/2, y: dx*s + dy*c + r.h/2 };// local in [0..w],[0..h]
  }
  function localToWorldRect(px,py,r){ const cx=r.x+r.w/2, cy=r.y+r.h/2; const lx=px - r.w/2, ly=py - r.h/2; const s=Math.sin(r.rot||0), c=Math.cos(r.rot||0); return { x: cx + lx*c - ly*s, y: cy + lx*s + ly*c };
  }

  function rectHandles(r){ // corners + edges + rotate (top-center offset)
    const pts=[]; // corners
    [[0,0],[r.w,0],[0,r.h],[r.w,r.h]].forEach(([px,py])=> pts.push(localToWorldRect(px,py,r)));
    // edges mid
    [[r.w/2,0],[r.w/2,r.h],[0,r.h/2],[r.w,r.h/2]].forEach(([px,py])=> pts.push(localToWorldRect(px,py,r)));
    // rotate handle (above top edge by 16px)
    const topMid = localToWorldRect(r.w/2,0,r);
    const nx = Math.cos(r.rot||0), ny = Math.sin(r.rot||0); // forward vector along +x local
    const tx = -Math.sin(r.rot||0), ty = Math.cos(r.rot||0); // up vector (negative local y)
    const rotHandle = { x: topMid.x + tx* -16, y: topMid.y + ty* -16 };
    return {corners:pts.slice(0,4), edges:pts.slice(4,8), rotate:rotHandle};
  }

  function drawRotatedRect(r, selected=false){ ctx.save(); const cx=r.x+r.w/2, cy=r.y+r.h/2; ctx.translate(cx,cy); ctx.rotate(r.rot||0); ctx.fillStyle='rgba(34,197,94,.12)'; ctx.strokeStyle= selected? '#fbbf24':'#22c55e44'; ctx.lineWidth=2; ctx.fillRect(-r.w/2,-r.h/2,r.w,r.h); ctx.strokeRect(-r.w/2,-r.h/2,r.w,r.h); ctx.restore(); if(selected){ const h=rectHandles(r); ctx.fillStyle='#f59e0b'; h.corners.forEach(p=> ctx.fillRect(p.x-5,p.y-5,10,10)); ctx.fillStyle='#fde68a'; h.edges.forEach(p=> ctx.fillRect(p.x-4,p.y-4,8,8)); // rotate
    ctx.beginPath(); ctx.arc(h.rotate.x,h.rotate.y,6,0,Math.PI*2); ctx.fillStyle='#60a5fa'; ctx.fill(); ctx.strokeStyle='#1e3a8a'; ctx.stroke(); }
  }

  function drawHardscape(){ ctx.lineWidth=3; for(let i=0;i<state.hardscape.length;i++){ const h=state.hardscape[i]; if(h.type==='path'){ ctx.strokeStyle = (state.selected.kind==='path'&&state.selected.index===i)?'#fbbf24':'#9ca3af'; if(h.points.length<2) continue; ctx.beginPath(); ctx.moveTo(h.points[0].x,h.points[0].y); for(let j=1;j<h.points.length;j++) ctx.lineTo(h.points[j].x,h.points[j].y); ctx.stroke(); if(state.selected.kind==='path' && state.selected.index===i){ ctx.fillStyle='#f59e0b'; for(const pt of h.points){ ctx.beginPath(); ctx.arc(pt.x,pt.y,5,0,Math.PI*2); ctx.fill(); }} }
    if(h.type==='rect'){ drawRotatedRect(h, state.selected.kind==='rect'&&state.selected.index===i); }
  }}

  function lerp(a,b,t){ return a + (b-a)*t; }
  function lerpColor(c1,c2,t){ // hex to rgb
    const a = [(c1>>16)&255, (c1>>8)&255, c1&255]; const b = [(c2>>16)&255, (c2>>8)&255, c2&255];
    const r = Math.round(lerp(a[0],b[0],t)), g=Math.round(lerp(a[1],b[1],t)), bl=Math.round(lerp(a[2],b[2],t));
    return `rgb(${r},${g},${bl})`;
  }

  function plantFillColor(p){ // shaded growth: early year -> lighter green, mature -> deeper
    const t = (state.growthYearDisplay-1)/(state.growthMax-1||1);
    const baseMin = 0xA9F5C9, baseMax = 0x167E3F; // light to deep
    const byWater = (p.water||'').toLowerCase();
    let c1=baseMin, c2=baseMax;
    if(byWater.includes('minimum')){ c1=0xCFF8E0; c2=0x2CA870; }
    if(byWater.includes('frequent')){ c1=0xBDE8B7; c2=0x1B8539; }
    return lerpColor(c1,c2,t);
  }

  function drawPlants(){ for(const p of state.placed){ const r=currentRadius(p); let conflict=false; for(const o of state.placed){ if(o===p) continue; const rr=currentRadius(o); const dx=p.x-o.x, dy=p.y-o.y; if(Math.hypot(dx,dy) < r+rr-2){ conflict=true; break; } }
      ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fillStyle = plantFillColor(p); ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle = conflict? '#f59e0b' : '#052e12'; ctx.stroke(); ctx.fillStyle='#ecfccb'; ctx.font='10px system-ui'; ctx.textAlign='center'; ctx.fillText(p.name.slice(0,18), p.x, p.y-r-6); }
  }

  function drawSelectionInfo(){ const el=$('#selectionInfo'); if(!state.selected.kind){ el.style.display='none'; return; } el.style.display='inline-block'; if(state.selected.kind==='plant'){ el.textContent='Plant selected'; } else if(state.selected.kind==='rect'){ el.textContent='Bed selected'; } else if(state.selected.kind==='path'){ el.textContent='Path selected'; } }

  function render2D(){ const rect=canvas.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height); drawGrid(); drawHardscape(); drawPlants(); drawSelectionInfo(); $('#btnDelete').style.display = state.selected.kind? 'inline-block':'none'; }

  // Interaction
  function hitPlant(x,y){ for(let i=state.placed.length-1;i>=0;i--){ const p=state.placed[i]; if(Math.hypot(p.x-x,p.y-y) <= currentRadius(p)+6) return i; } return -1; }
  function hitRectAt(x,y){ for(let i=state.hardscape.length-1;i>=0;i--){ const h=state.hardscape[i]; if(h.type!=='rect') continue; const local = worldToLocalRect(x,y,h); if(local.x>=0 && local.x<=h.w && local.y>=0 && local.y<=h.h) return i; } return -1; }
  function hitRectHandleAt(x,y,r){ const hs = rectHandles(r); // corners 0-3, edges 0-3
    for(let k=0;k<hs.corners.length;k++){ const p=hs.corners[k]; if(Math.abs(x-p.x)<=8 && Math.abs(y-p.y)<=8) return {corner:k}; }
    for(let k=0;k<hs.edges.length;k++){ const p=hs.edges[k]; if(Math.abs(x-p.x)<=8 && Math.abs(y-p.y)<=8) return {edge:k}; }
    const pr=hs.rotate; if(Math.hypot(x-pr.x,y-pr.y)<=10) return {rotate:true};
    return null;
  }

  function distToSegment(px,py,ax,ay,bx,by){ const vx=bx-ax, vy=by-ay; const wx=px-ax, wy=py-ay; const c1= vx*wx+vy*wy; if(c1<=0) return Math.hypot(px-ax,py-ay); const c2=vx*vx+vy*vy; if(c2<=c1) return Math.hypot(px-bx,py-by); const t=c1/c2; const projx=ax+t*vx, projy=ay+t*vy; return Math.hypot(px-projx,py-projy); }
  function hitPathNode(x,y){ for(let i=state.hardscape.length-1;i>=0;i--){ const h=state.hardscape[i]; if(h.type!=='path') continue; for(let j=0;j<h.points.length;j++){ if(Math.hypot(x-h.points[j].x,y-h.points[j].y)<=8) return {i,j}; } } return null; }
  function hitPathSegment(x,y){ let best=null, bestD=9; for(let i=state.hardscape.length-1;i>=0;i--){ const h=state.hardscape[i]; if(h.type!=='path'||h.points.length<2) continue; for(let j=0;j<h.points.length-1;j++){ const d=distToSegment(x,y,h.points[j].x,h.points[j].y,h.points[j+1].x,h.points[j+1].y); if(d<bestD){ bestD=d; best={i,j}; } } } return best && bestD<=10 ? best : null; }

  let modeAddRect=false, modeAddPath=false;

  canvas.addEventListener('mousedown', (e)=>{ const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; const shift=e.shiftKey, alt=e.altKey;
    // Plants
    const pi=hitPlant(x,y); if(pi!==-1){ state.selected={kind:'plant',index:pi,node:-1,handle:null}; state.dragging={kind:'plant',index:pi,dx:x-state.placed[pi].x,dy:y-state.placed[pi].y}; openDetailsForPlaced(pi); render2D(); return; }

    // Add rect
    if(modeAddRect){ state.drawing.rect={type:'rect', x:roundSnap(x), y:roundSnap(y), w:1, h:1, rot:0}; state.selected={kind:'rect',index:-1,node:-1,handle:null}; render2D(); return; }
    // Add path
    if(modeAddPath){ if(!state.drawing.path){ state.drawing.path={type:'path', points:[{x:roundSnap(x),y:roundSnap(y)}]}; } else { state.drawing.path.points.push({x:roundSnap(x),y:roundSnap(y)});} state.selected={kind:'path',index:-1,node:-1,handle:null}; render2D(); return; }

    // Path nodes first (Alt+click to delete)
    const node = hitPathNode(x,y); if(node){ if(e.altKey){ const p=state.hardscape[node.i]; p.points.splice(node.j,1); if(p.points.length<2){ state.hardscape.splice(node.i,1); state.selected={kind:null,index:-1,node:-1,handle:null}; } pushHistory('delete node'); render2D(); render3D(); return; } state.selected={kind:'path',index:node.i,node:node.j,handle:null}; state.dragging={kind:'path-node',index:node.i,node:node.j}; render2D(); return; }
    // Insert node by double-click handled in dblclick

    // Rect handles
    const riHandle = (()=>{ for(let i=state.hardscape.length-1;i>=0;i--){ const h=state.hardscape[i]; if(h.type==='rect'){ const hh=hitRectHandleAt(x,y,h); if(hh){ state.selected={kind:'rect',index:i,node:-1,handle:hh}; return {i,hh}; } } } return null; })();
    if(riHandle){ const i=riHandle.i, h=riHandle.hh; if(h.corner!=null||h.edge!=null){ state.dragging={kind:'rect-resize',index:i,handle:h, start:{x,y}, orig:{...state.hardscape[i]}, shift, alt}; return; } if(h.rotate){ state.dragging={kind:'rect-rotate',index:i, start:{x,y}}; return; } }

    // Rect body move
    const ri=hitRectAt(x,y); if(ri!==-1){ const r=state.hardscape[ri]; const local=worldToLocalRect(x,y,r); state.selected={kind:'rect',index:ri,node:-1,handle:null}; state.dragging={kind:'rect',index:ri,dx:local.x - r.w/2, dy:local.y - r.h/2}; render2D(); return; }

    // Path segment select/move
    const seg = hitPathSegment(x,y); if(seg){ state.selected={kind:'path',index:seg.i,node:-1,handle:null}; state.dragging={kind:'path-move',index:seg.i,dx:x,dy:y}; render2D(); return; }

    state.selected={kind:null,index:-1,node:-1,handle:null}; render2D();
  });

  canvas.addEventListener('mousemove', (e)=>{ const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; const shift=e.shiftKey, alt=e.altKey;
    if(state.dragging){ const d=state.dragging; if(d.kind==='plant'){ const p=state.placed[d.index]; p.x=clamp(roundSnap(x-d.dx),10,rect.width-10); p.y=clamp(roundSnap(y-d.dy),10,rect.height-10); render2D(); render3D(); return; }
      if(d.kind==='rect'){ const r=state.hardscape[d.index]; // move in rect-local preserves offset
        const world = localToWorldRect(r.w/2 + d.dx, r.h/2 + d.dy, r); const cx0 = r.x + r.w/2, cy0 = r.y + r.h/2; const cx = Math.max(0, Math.min(rect.width, world.x)); const cy = Math.max(0, Math.min(rect.height, world.y)); r.x = cx - r.w/2; r.y = cy - r.h/2; render2D(); return; }
      if(d.kind==='rect-rotate'){ const r=state.hardscape[d.index]; const cx=r.x+r.w/2, cy=r.y+r.h/2; r.rot = Math.atan2(y-cy, x-cx) + Math.PI/2; render2D(); return; }
      if(d.kind==='rect-resize'){ const r=state.hardscape[d.index]; const o=d.orig; // work in local space
        // compute local coords of current mouse
        const loc = worldToLocalRect(x,y,o); let nx=o.x, ny=o.y, nw=o.w, nh=o.h;
        const centerResize = d.alt;
        if(d.handle.corner!=null){ const c=d.handle.corner; if(c===0){ // nw
            let dw = o.w - loc.x; let dh = o.h - loc.y; if(d.shift){ const ar=o.w/o.h||1; if(Math.abs(dw/dh)>ar){ dw = dh*ar; } else { dh = dw/ar; } }
            nw = Math.max(4, loc.x); nh = Math.max(4, loc.y); nx = o.x + (o.w - nw); ny = o.y + (o.h - nh);
          }
          if(c===1){ // ne
            let dw = loc.x; let dh = o.h - loc.y; if(d.shift){ const ar=o.w/o.h||1; if(Math.abs(dw/dh)>ar){ dw = dh*ar; } else { dh = dw/ar; } }
            nw = Math.max(4, dw); nh = Math.max(4, o.h - dh); nx = o.x; ny = o.y + (o.h - nh);
          }
          if(c===2){ // sw
            let dw = o.w - loc.x; let dh = loc.y; if(d.shift){ const ar=o.w/o.h||1; if(Math.abs(dw/dh)>ar){ dw = dh*ar; } else { dh = dw/ar; } }
            nw = Math.max(4, o.w - (o.w - dw)); nh = Math.max(4, dh); nx = o.x + (o.w - nw); ny = o.y;
          }
          if(c===3){ // se
            let dw = loc.x; let dh = loc.y; if(d.shift){ const ar=o.w/o.h||1; if(Math.abs(dw/dh)>ar){ dw = dh*ar; } else { dh = dw/ar; } }
            nw = Math.max(4, dw); nh = Math.max(4, dh); nx = o.x; ny = o.y;
          }
        }
        if(d.handle.edge!=null){ const eidx=d.handle.edge; if(eidx===0){ // top
            nh = Math.max(4, loc.y); ny = o.y + (o.h - nh);
          }
          if(eidx===1){ // bottom
            nh = Math.max(4, loc.y); ny = o.y;
          }
          if(eidx===2){ // left
            nw = Math.max(4, loc.x); nx = o.x + (o.w - nw);
          }
          if(eidx===3){ // right
            nw = Math.max(4, loc.x); nx = o.x;
          }
          if(d.shift){ const ar=o.w/o.h||1; nh = nw/ar; ny = o.y + (o.h - nh); }
        }
        if(centerResize){ const cx=o.x+o.w/2, cy=o.y+o.h/2; nx = cx - nw/2; ny = cy - nh/2; }
        // apply to r (preserve rotation)
        const rot = r.rot; r.x=nx; r.y=ny; r.w=nw; r.h=nh; r.rot=rot; render2D(); return; }
      if(d.kind==='path-node'){ const p=state.hardscape[d.index]; p.points[d.node].x=roundSnap(x); p.points[d.node].y=roundSnap(y); render2D(); return; }
      if(d.kind==='path-move'){ const p=state.hardscape[d.index]; const ddx=roundSnap(x)-d.dx; const ddy=roundSnap(y)-d.dy; d.dx=roundSnap(x); d.dy=roundSnap(y); for(const pt of p.points){ pt.x+=ddx; pt.y+=ddy; } render2D(); return; }
    }

    if(state.drawing.rect){ const r=state.drawing.rect; // initial rect aligned
      r.w = roundSnap(x) - r.x; r.h = roundSnap(y) - r.y; render2D(); ctx.save(); ctx.setLineDash([6,6]); ctx.strokeStyle='#22c55e'; ctx.strokeRect(r.x,r.y,r.w,r.h); ctx.restore(); return; }
  });

  window.addEventListener('mouseup', ()=>{ if(state.dragging){ pushHistory('edit'); state.dragging=null; return; } if(state.drawing.rect){ let r=state.drawing.rect; if(Math.abs(r.w)>4 && Math.abs(r.h)>4){ if(r.w<0){ r.x+=r.w; r.w*=-1; } if(r.h<0){ r.y+=r.h; r.h*=-1;} state.hardscape.push(r); pushHistory('add rect'); } state.drawing.rect=null; render2D(); return; } });

  window.addEventListener('dblclick', (e)=>{ const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; const seg=hitPathSegment(x,y); if(seg){ const p=state.hardscape[seg.i]; // insert at segment position
      // find projection point
      const A=p.points[seg.j], B=p.points[seg.j+1]; const vx=B.x-A.x, vy=B.y-A.y; const wx=x-A.x, wy=y-A.y; const t=clamp((vx*wx+vy*wy)/((vx*vx+vy*vy)||1),0,1); const px=A.x + vx*t, py=A.y + vy*t; p.points.splice(seg.j+1,0,{x:roundSnap(px),y:roundSnap(py)}); pushHistory('insert node'); render2D(); }
  });

  // Delete selection
  function deleteSelection(){ if(!state.selected.kind) return; if(state.selected.kind==='plant'){ state.placed.splice(state.selected.index,1); } else if(state.selected.kind==='rect'){ state.hardscape.splice(state.selected.index,1); } else if(state.selected.kind==='path'){ state.hardscape.splice(state.selected.index,1); } state.selected={kind:null,index:-1,node:-1,handle:null}; pushHistory('delete'); render2D(); render3D(); }
  window.addEventListener('keydown', (e)=>{ const tag=(document.activeElement.tagName||'').toUpperCase(); const modInput=['INPUT','TEXTAREA'].includes(tag); if((e.key==='Delete'||e.key==='Backspace') && !modInput){ deleteSelection(); }
    // Undo/Redo
    const z=(e.ctrlKey||e.metaKey)&&!e.shiftKey&&e.key.toLowerCase()==='z'; const y=(e.ctrlKey||e.metaKey)&& e.key.toLowerCase()==='y'; const zr=(e.ctrlKey||e.metaKey)&& e.shiftKey && e.key.toLowerCase()==='z'; if(z){ e.preventDefault(); undo(); } if(y||zr){ e.preventDefault(); redo(); }
  });
  $('#btnDelete').onclick = deleteSelection; $('#btnUndo').onclick=undo; $('#btnRedo').onclick=redo;

  // Rain
  let drops=[]; function toggleRain(){ state.isRaining=!state.isRaining; if(state.isRaining){ spawnRain(); } }
  function spawnRain(){ const rect=rainCanvas.getBoundingClientRect(); drops=Array.from({length:200},()=>({x:Math.random()*rect.width, y:Math.random()*-rect.height, v:2+Math.random()*4, l:8+Math.random()*10})); requestAnimationFrame(rainLoop); }
  function rainLoop(){ if(!state.isRaining){ rainCtx.clearRect(0,0,rainCanvas.width,rainCanvas.height); return; } const rect=rainCanvas.getBoundingClientRect(); rainCtx.setTransform(window.devicePixelRatio||1,0,0,window.devicePixelRatio||1,0,0); rainCtx.clearRect(0,0,rect.width,rect.height); rainCtx.strokeStyle='#60a5fa'; rainCtx.lineWidth=1; for(const d of drops){ rainCtx.beginPath(); rainCtx.moveTo(d.x,d.y); rainCtx.lineTo(d.x,d.y+d.l); rainCtx.stroke(); d.y+=d.v*3; if(d.y>rect.height){ d.y=-Math.random()*100; d.x=Math.random()*rect.width; } } requestAnimationFrame(rainLoop); }

  // 3D
  let renderer, scene, camera, controls, animId; const WORLD_W=120, WORLD_H=80;
  function init3D(){ const container=$('#scene3d'); const w=container.clientWidth||container.getBoundingClientRect().width; const h=container.clientHeight||container.getBoundingClientRect().height; renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(w,h); container.innerHTML=''; container.appendChild(renderer.domElement); scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b1220); camera=new THREE.PerspectiveCamera(50,w/h,0.1,1000); setCameraPreset(state.cameraPreset,true); const hemi=new THREE.HemisphereLight(0xaadfff,0x223311,0.6); scene.add(hemi); const dir=new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(40,60,20); scene.add(dir); const ground=new THREE.Mesh(new THREE.PlaneGeometry(WORLD_W,WORLD_H), new THREE.MeshStandardMaterial({color:0x12351d, roughness:1, metalness:0})); ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground); controls=new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.dampingFactor=0.08; controls.minDistance=20; controls.maxDistance=220; controls.maxPolarAngle=1.55; animate3D(); }
  function animate3D(){ controls && controls.update(); renderer && renderer.render(scene,camera); animId=requestAnimationFrame(animate3D); }
  function clear3DMeshes(){ const toRemove=[]; scene.traverse(o=>{ if(o.isMesh && o.geometry.type!=='PlaneGeometry') toRemove.push(o); }); toRemove.forEach(m=>scene.remove(m)); }
  function setCameraPreset(preset, init=false){ state.cameraPreset=preset; if(!camera) return; if(preset==='top'){ camera.position.set(0, 100, 0.001); camera.lookAt(0,0,0); if(controls){ controls.target.set(0,0,0); controls.enableRotate=false; controls.enablePan=true; } }
    if(preset==='oblique'){ camera.position.set(30,40,70); camera.lookAt(0,0,0); if(controls){ controls.target.set(0,0,0); controls.enableRotate=true; } }
    if(preset==='reset'){ camera.position.set(0,40,80); camera.lookAt(0,0,0); if(controls){ controls.target.set(0,0,0); controls.enableRotate=true; } }
    if(!init && controls){ controls.update(); }
  }

  function render3D(){ if(!scene) return; clear3DMeshes(); const rect=$('#garden2d').getBoundingClientRect(); const sx=WORLD_W/rect.width, sz=WORLD_H/rect.height;
    // Plants (shaded by growth)
    state.placed.forEach(p=>{ const x=(p.x/rect.width-0.5)*WORLD_W; const z=(p.y/rect.height-0.5)*WORLD_H; const height=(p.heightCm? metersToPx(p.heightCm/100): 6) * (state.growthYearDisplay/state.growthMax*0.8 + 0.2); const rad=currentRadius(p)/8; const colCSS = plantFillColor(p); // convert rgb to int
      const m = colCSS.match(/rgb\((\d+),(\d+),(\d+)\)/); const col = m? ( (parseInt(m[1])<<16) | (parseInt(m[2])<<8) | parseInt(m[3]) ) : 0x22c55e;
      const geo=new THREE.CylinderGeometry(Math.max(0.4,rad*0.9), Math.max(0.5,rad), Math.max(2.5,height), 12); const mat=new THREE.MeshStandardMaterial({color:col, roughness:.9, metalness:0}); const mesh=new THREE.Mesh(geo,mat); mesh.position.set(x, Math.max(1.2,height/2), z); scene.add(mesh); });
    // Rect beds
    const bedMat=new THREE.MeshStandardMaterial({color:0x6b4f2a, roughness:1});
    state.hardscape.filter(h=>h.type==='rect').forEach(r=>{ // approximate via box ignoring rotation in 3D for simplicity
      const cx=(r.x+r.w/2)/rect.width*WORLD_W - WORLD_W/2; const cz=(r.y+r.h/2)/rect.height*WORLD_H - WORLD_H/2; const w=Math.abs(r.w)*sx; const d=Math.abs(r.h)*sz; const box=new THREE.Mesh(new THREE.BoxGeometry(Math.max(.5,w), 0.2, Math.max(.5,d)), bedMat); box.position.set(cx,0.1,cz); scene.add(box); });
    // Paths as narrow quads
    const pathMat=new THREE.MeshStandardMaterial({color:0x9ca3af, roughness:.95, metalness:.05});
    state.hardscape.filter(h=>h.type==='path').forEach(p=>{ if(p.points.length<2) return; for(let i=0;i<p.points.length-1;i++){ const a=p.points[i], b=p.points[i+1]; const ax=(a.x/rect.width-0.5)*WORLD_W, az=(a.y/rect.height-0.5)*WORLD_H; const bx=(b.x/rect.width-0.5)*WORLD_W, bz=(b.y/rect.height-0.5)*WORLD_H; const dx=bx-ax, dz=bz-az; const len=Math.hypot(dx,dz)||0.001; const geo=new THREE.PlaneGeometry(len, 0.8); const m=new THREE.Mesh(geo,pathMat); m.rotation.x=-Math.PI/2; const ang=Math.atan2(dz,dx); m.rotation.y=-ang; m.position.set((ax+bx)/2, 0.11, (az+bz)/2); scene.add(m); } });
  }

  // Palette
  function parsePalettePrompt(text){ const t=text.toLowerCase(); return { lowWater:/(low[- ]?water|drought)/.test(t), shade:/(shade|shady)/.test(t), sun:/(full\s*sun)/.test(t), pollinators:/(butterfl|bee|pollinat)/.test(t), lowMaintenance:/(low\s*maint|easy)/.test(t), }; }
  async function betterPalette(){ const text=$('#palettePrompt').value||''; const prefs=parsePalettePrompt(text); const subset=state.plants.slice(0,100); await Promise.all(subset.map(p=>ensureDetails(p.id))); const eligible=subset.map(p=>state.details[p.id]).filter(Boolean).filter(d=>{ let zoneOk=true; if(d.hardiness){ const m=d.hardiness.match(/(\d+)\s*[-–]\s*(\d+)/)||d.hardiness.match(/\b(\d{1,2})\b/); if(m){ if(m.length===3){ const lo=+m[1], hi=+m[2]; zoneOk=(ZONE_TARGET>=lo&&ZONE_TARGET<=hi);} else zoneOk=(+m[1])===ZONE_TARGET; } } if(!zoneOk)return false; if(prefs.lowWater && !(String(d.watering).toLowerCase().includes('minimum')||String(d.watering).toLowerCase().includes('low'))) return false; if(prefs.sun && !(d.sunlight||[]).includes('full_sun')) return false; if(prefs.shade && !((d.sunlight||[]).includes('full_shade')||(d.sunlight||[]).includes('part_shade'))) return false; if(prefs.lowMaintenance && !(String(d.maintenance).toLowerCase().includes('low')||String(d.maintenance).toLowerCase().includes('none'))) return false; return true; }); const scored=eligible.map(d=>({d,score:(d.spreadCm?2:0)+(d.default_image?1:0)})).sort((a,b)=>b.score-a.score).slice(0,10); scored.forEach(s=> addPlantToCanvas(s.d)); closeModal('#modalPalette'); }

  // Details Drawer
  async function openDetailsForPlaced(idx){ const item=state.placed[idx]; await ensureDetails(item.id); const d=state.details[item.id]||{}; const img=(d.default_image&&(d.default_image.thumbnail||d.default_image.small_url))||''; $('#drawerTitle').textContent=item.name||d.common_name||'Details'; const spacing=item.spreadCm?Math.round(item.spreadCm):(d.spreadCm?Math.round(d.spreadCm):null); const spacingText=spacing?`${spacing} cm (≈ mature spread)`: '—'; $('#drawerBody').innerHTML=`
    <div class="panel" style="display:flex; gap:10px; align-items:flex-start">
      <img src="${img}" alt="${item.name}" style="width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid #1f2937"/>
      <div style="flex:1">
        <div class="small">${(d.scientific_name||[]).join(', ')}</div>
        <div style="margin-top:4px">Water: <strong>${d.watering||item.water||'—'}</strong></div>
        <div>Sun: <strong>${(d.sunlight||[item.sun]).join(' / ')}</strong></div>
        <div>Maintenance: <strong>${d.maintenance||'—'}</strong></div>
      </div>
    </div>
    <div class="panel" style="margin-top:10px">
      <div><strong>Mature Size</strong></div>
      <div class="small">Height: ${d.heightCm? Math.round(d.heightCm)+' cm':'—'} • Spread: ${d.spreadCm? Math.round(d.spreadCm)+' cm':'—'}</div>
      <div class="small">Recommended spacing: ${spacingText}</div>
    </div>
    <div class="panel" style="margin-top:10px">
      <div><strong>Notes</strong></div>
      <div class="small">${d.description? d.description.slice(0,280)+'…' : (d.notes||'No notes available.')}</div>
      <div style="margin-top:8px"><a target="_blank" href="https://perenual.com/plant-species-database-search-finder?search=${encodeURIComponent(item.name)}">View references ↗</a></div>
    </div>`; $('#drawer').classList.add('show'); }

  async function openDetailsForLibrary(id){ const p=state.plants.find(x=>x.id===id); if(!p) return; const idx=state.placed.findIndex(x=>x.id===id); if(idx>-1){ openDetailsForPlaced(idx); return; } await ensureDetails(id); const d=state.details[id]; const spacing=d.spreadCm?Math.round(d.spreadCm)+' cm':'—'; const img=(d.default_image&&(d.default_image.thumbnail||d.default_image.small_url))||p.image_url||''; $('#drawerTitle').textContent=d.common_name||'Details'; $('#drawerBody').innerHTML=`
    <div class="panel" style="display:flex; gap:10px; align-items:flex-start">
      <img src="${img}" alt="${d.common_name}" style="width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid #1f2937"/>
      <div style="flex:1">
        <div class="small">${(d.scientific_name||[]).join(', ')}</div>
        <div style="margin-top:4px">Water: <strong>${d.watering||'—'}</strong></div>
        <div>Sun: <strong>${(d.sunlight||[]).join(' / ')}</strong></div>
        <div>Maintenance: <strong>${d.maintenance||'—'}</strong></div>
      </div>
    </div>
    <div class="panel" style="margin-top:10px">
      <div><strong>Mature Size</strong></div>
      <div class="small">Height: ${d.heightCm? Math.round(d.heightCm)+' cm':'—'} • Spread: ${d.spreadCm? Math.round(d.spreadCm)+' cm':'—'}</div>
      <div class="small">Recommended spacing: ${spacing}</div>
    </div>
    <div class="panel" style="margin-top:10px">
      <button class="btn primary" id="placeFromDrawer">Place in Garden</button>
    </div>`; $('#drawer').classList.add('show'); $('#placeFromDrawer').onclick=()=>addPlantToCanvas(p); }

  $('#btnCloseDrawer').onclick=()=> $('#drawer').classList.remove('show');
  $('#btnReplaceSimilar').onclick=()=>{ const s=state.selected; if(s.kind!=='plant') return; const ref=state.placed[s.index]; const cands=state.plants.filter(p=> p.id!==ref.id && String(p.watering||'').toLowerCase()===String(ref.water||'').toLowerCase() && (p.sunlight||[]).some(su=>su===ref.sun)); if(!cands.length) return; const choice=cands[Math.floor(Math.random()*Math.min(10,cands.length))]; state.placed[s.index].id=choice.id; state.placed[s.index].name=choice.common_name||'Unknown'; state.placed[s.index].water=choice.watering||ref.water; state.placed[s.index].sun=(choice.sunlight||[])[0]||ref.sun; state.details[choice.id]||=null; updateGrowthData().then(()=>{ render2D(); render3D(); openDetailsForPlaced(s.index); }); };

  // Export & Save
  function exportList(){ const counts={}; for(const p of state.placed){ counts[p.name]=(counts[p.name]||0)+1; } const lines=Object.entries(counts).map(([n,q])=>`${q}× ${n}`); const blob=new Blob([lines.join('\n')||'No plants placed.'],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plant-shopping-list.txt'; a.click(); URL.revokeObjectURL(a.href); }
  function exportPNG(){ const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='garden-layout.png'; a.click(); }
  function savePlan(){ const data={ placed:state.placed, hardscape:state.hardscape, growthMax:state.growthMax, pxPerMeter:state.pxPerMeter }; localStorage.setItem('garden_plan_v4', JSON.stringify(data)); alert('Saved'); }
  function loadPlan(){ const raw=localStorage.getItem('garden_plan_v4'); if(!raw) return; const d=JSON.parse(raw); state.placed=d.placed||[]; state.hardscape=d.hardscape||[]; state.growthMax=d.growthMax||8; state.pxPerMeter=d.pxPerMeter||40; $('#growthMax').textContent=state.growthMax; $('#scaleLabel').textContent=`1 m ≈ ${state.pxPerMeter} px`; updateGrowthData().then(()=>{ render2D(); render3D(); }); }

  // Templates
  function applyTemplate(kind){ state.placed=[]; state.hardscape=[]; const rect=canvas.getBoundingClientRect(); function rand(name){ addPlantToCanvas({id:'custom_'+name, common_name:name, watering:'Average', sunlight:['full_sun']}, Math.random()*rect.width, Math.random()*rect.height);} if(kind==='cottage'){ ['Lavender','Foxglove','Delphinium','Rose','Chive','Thyme','Peony'].forEach(rand); state.hardscape.push({type:'rect',x:rect.width*0.15,y:rect.height*0.2,w:rect.width*0.7,h:rect.height*0.5,rot:0}); } if(kind==='modern'){ ['Boxwood','Hosta','Hakone Grass','Allium','Heuchera','Yucca'].forEach(rand); state.hardscape.push({type:'path',points:[{x:rect.width*0.1,y:rect.height*0.8},{x:rect.width*0.9,y:rect.height*0.2}]}); } if(kind==='zen'){ ['Japanese Maple','Moss','Fern','Bamboo','Azalea','Iris'].forEach(rand); } render2D(); render3D(); pushHistory('template'); }

  // View & Controls
  function to2D(){ state.view='2d'; $('#scene3d').style.display='none'; $('#garden2d').style.display='block'; render2D(); }
  function to3D(){ state.view='3d'; $('#scene3d').style.display='block'; $('#garden2d').style.display='none'; if(!renderer) init3D(); render3D(); }

  // XLSX Import
  function normalizeSun(v){ v=String(v||'').toLowerCase(); if(/full/.test(v)&&/sun/.test(v)) return 'full_sun'; if(/part/.test(v)&&/shade|sun/.test(v)) return 'part_shade'; if(/full/.test(v)&&/shade/.test(v)) return 'full_shade'; return ''; }
  async function importXLSX(file){ const data = await file.arrayBuffer(); const wb = XLSX.read(data, {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws, {defval:''}); let counter=0; rows.forEach(r=>{ const id = 'xlsx_'+(++counter); const sci = (r['Scientific Name']||r['Scientific']||'').split(',').map(s=>s.trim()).filter(Boolean); const p = { id, common_name: r['Common Name']||r['Name']||`Custom ${counter}`, scientific_name: sci, watering: r['Watering']||r['Water']||'Average', sunlight: [normalizeSun(r['Sunlight']||r['Sun']||'')].filter(Boolean), image_url: r['Image URL']||'', maintenance: r['Maintenance']||'', heightCm: parseFloat(r['Height (cm)']||r['Height cm']||'')||null, spreadCm: parseFloat(r['Spread (cm)']||r['Spread cm']||'')||null, hardiness: String(r['Zone']||'')||'', notes: r['Notes']||'' };
      state.plants.push(p); state.details[id] = { id, common_name:p.common_name, scientific_name:p.scientific_name, watering:p.watering, sunlight:p.sunlight, maintenance:p.maintenance, heightCm:p.heightCm, spreadCm:p.spreadCm, hardiness:p.hardiness, default_image:{small_url:p.image_url}, description:p.notes, notes:p.notes };
    }); drawLibrary(); alert('Imported '+rows.length+' custom plants.'); }

  // Events
  window.addEventListener('DOMContentLoaded', ()=>{ resize(); loadWeather(); if(state.apiKey) fetchLibrary(); else $('#library').innerHTML='<div class="small">Tip: Click <strong>Import .xlsx</strong> to add your custom plant list, or add a Perenual API key to load online species.</div>';
    $('#btnApiKey').onclick=()=> showModal('#modalKey'); $('#saveKey').onclick=()=>{ state.apiKey=$('#apiKeyInput').value.trim(); if(state.apiKey){ localStorage.setItem('perenual_api_key',state.apiKey); closeModal('#modalKey'); fetchLibrary(); } };
    $('#btnImportXLSX').onclick=()=> $('#fileXLSX').click(); $('#fileXLSX').onchange=(e)=>{ const f=e.target.files[0]; if(f) importXLSX(f); };

    $('#search').oninput=(e)=>{ state.filters.q=e.target.value; drawLibrary(); }; $('#sunChips').addEventListener('click',(e)=>{ if(!e.target.classList.contains('chip')) return; state.filters.sunlight=e.target.dataset.value; setActiveChip('#sunChips', state.filters.sunlight); drawLibrary();}); $('#waterChips').addEventListener('click',(e)=>{ if(!e.target.classList.contains('chip')) return; state.filters.watering=e.target.dataset.value; setActiveChip('#waterChips', state.filters.watering); drawLibrary();}); setActiveChip('#sunChips',''); setActiveChip('#waterChips','');

    $('#btnTemplates').onclick=()=> showModal('#modalTemplates'); $$('#modalTemplates [data-template]').forEach(b=> b.onclick=()=>{ applyTemplate(b.dataset.template); closeModal('#modalTemplates'); }); $$('#modalTemplates [data-close]').forEach(b=> b.onclick=()=> closeModal('#modalTemplates'));

    $('#btnExport').onclick=()=> showModal('#modalExport'); $('#exportList').onclick=exportList; $('#exportPNG').onclick=exportPNG; $('#shareAI').onclick=()=>{ $('#shareText').value=generateShareText(); }; $('#copyShare').onclick=()=>{ navigator.clipboard.writeText($('#shareText').value||''); };

    $('#btnPalette').onclick=()=> showModal('#modalPalette'); $('#generatePalette').onclick=betterPalette; $$('#modalPalette [data-close]').forEach(b=> b.onclick=()=> closeModal('#modalPalette'));

    $('#btnSave').onclick=savePlan; $('#btnLoad').onclick=loadPlan; $('#btnClear').onclick=()=>{ state.placed=[]; state.hardscape=[]; state.selected={kind:null,index:-1,node:-1,handle:null}; pushHistory('clear'); render2D(); render3D(); };
    $('#btn2D').onclick=to2D; $('#btn3D').onclick=to3D; $('#btnRain').onclick=()=> toggleRain(); $('#btnAddRect').onclick=()=>{ modeAddRect=!modeAddRect; modeAddPath=false; toggleButtons(); }; $('#btnAddPath').onclick=()=>{ modeAddPath=!modeAddPath; modeAddRect=false; toggleButtons(); }; $('#btnRefreshLib').onclick=()=> fetchLibrary();
    const year=$('#yearSlider'), gl=$('#growthLabel'), gmax=$('#growthMax'); year.oninput=()=>{ state.growthYearTarget=+year.value; gl.textContent=state.growthYearTarget; updateGrowthData().then(()=>{ animateGrowth(); }); }; gmax.textContent=state.growthMax; gl.textContent=state.growthYearTarget;
    $('#snapToggle').onchange=(e)=>{ state.snap=e.target.checked; };
    $('#camTop').onclick=()=>{ setCameraPreset('top'); }; $('#camOblique').onclick=()=>{ setCameraPreset('oblique'); }; $('#camReset').onclick=()=>{ setCameraPreset('reset'); };

    // Seed history
    pushHistory('init');
  });

  function setActiveChip(groupSel, value){ $$(groupSel+' .chip').forEach(c=>c.classList.toggle('active', c.dataset.value===value)); }
  function toggleButtons(){ $('#btnAddRect').classList.toggle('primary', modeAddRect); $('#btnAddPath').classList.toggle('primary', modeAddPath); }
  function generateShareText(){ if(!state.placed.length) return 'I designed a new garden plan with an open canvas ready for ideas!'; const counts={}; for(const p of state.placed){ counts[p.name]=(counts[p.name]||0)+1; } const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([n,q])=>`${q}× ${n}`); return `🌿 Highlights: ${top.join(', ')} • ${new Set(state.placed.map(p=>p.water)).size} watering levels • ${new Set(state.placed.map(p=>p.sun||'sun')).size} sun exposures.`; }

  // Weather
  async function loadWeather(){ try{ const url='https://api.open-meteo.com/v1/forecast?latitude=51.0447&longitude=-114.0719&current_weather=true&timezone=auto'; const res=await fetch(url); const data=await res.json(); const cw=data.current_weather; $('#weather').textContent=`${cw.temperature}°C, wind ${cw.windspeed} km/h`; }catch(e){ $('#weather').textContent='Weather unavailable'; } }

  </script>
</body>
</html>